<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Lato:wght@300;400;700&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ==================== CSS æ ¸å¿ƒæ ·å¼ ==================== */
        :root {
            --gold: #FFD700;
            --purple-deep: #1a0b2e;
            --glass-bg: rgba(20, 20, 35, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --accent-pink: #ff00cc;
            /* å­—ä½“å˜é‡å®šä¹‰ */
            --font-en-title: 'Cinzel Decorative', cursive;
            --font-en-body: 'Lato', sans-serif;
            --font-cn-title: 'Noto Serif SC', serif;
            --font-cn-body: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--purple-deep); /* é»˜è®¤åº•è‰²é˜²æ­¢é—ªç™½ */
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            transition: background-image 0.8s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* --- å­—ä½“é€‚é… --- */
        /* ä¸­æ–‡æ¨¡å¼ */
        body.lang-cn { font-family: var(--font-cn-body); }
        body.lang-cn .serif-font { font-family: var(--font-cn-title); }
        /* è‹±æ–‡æ¨¡å¼ï¼šä½¿ç”¨æ›´ä¼˜é›…çš„è£…é¥°å­—ä½“ */
        body.lang-en { font-family: var(--font-en-body); letter-spacing: 0.5px; }
        body.lang-en h1, body.lang-en h2, body.lang-en h3, body.lang-en .serif-font { 
            font-family: var(--font-en-title); letter-spacing: 1.5px; font-weight: 900; 
        }

        /* --- èƒŒæ™¯æ¸å˜å±‚ (å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€æ’å…¥) --- */
        /* å¤œæ™šæ¸å˜å±‚ */
        body.night-mode {
            background-image: linear-gradient(to bottom, rgba(10, 10, 30, 0.7), rgba(30, 20, 60, 0.8));
            /* JS å°†åœ¨æ­¤å¤„è¿½åŠ  url(...) */
        }
        /* ç™½å¤©æ¸å˜å±‚ */
        body.day-mode {
            background-image: linear-gradient(to bottom, rgba(120, 80, 180, 0.4), rgba(255, 150, 200, 0.3));
             /* JS å°†åœ¨æ­¤å¤„è¿½åŠ  url(...) */
        }

        /* æ˜Ÿæ˜ŸåŠ¨ç”»å±‚ */
        .stars-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; mix-blend-mode: screen;}
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- è¯­è¨€åˆ‡æ¢å™¨ --- */
        .lang-switch { position: absolute; top: 25px; right: 25px; z-index: 10; display: flex; gap: 10px; }
        .lang-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #ddd;
            padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 0.85rem; backdrop-filter: blur(5px);
        }
        .lang-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .lang-btn.active { background: var(--gold); color: #1a0b2e; border-color: var(--gold); font-weight: bold; }

        /* --- ä¸»å®¹å™¨ --- */
        .container { width: 90%; max-width: 580px; margin: 80px auto 60px; text-align: center; z-index: 2; position: relative; }

        h1 {
            font-size: 2.4rem; margin-bottom: 15px;
            background: linear-gradient(to right, #fff 20%, var(--gold) 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.4); line-height: 1.2;
        }
        .subtitle { font-size: 1.05rem; color: rgba(255,255,255,0.8); margin-bottom: 35px; font-weight: 300; letter-spacing: 0.5px; }

        /* --- å¡ç‰‡é€šç”¨æ ·å¼ --- */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: 20px; padding: 30px; margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); transition: transform 0.3s;
        }
        
        /* è¡¨å•æ ·å¼ */
        .input-group { text-align: left; margin-bottom: 18px; }
        label { color: var(--gold); font-size: 0.85rem; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700;}
        input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 10px;
            color: #fff; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); background: rgba(0,0,0,0.4); box-shadow: 0 0 12px rgba(255, 215, 0, 0.2); }
        /* ä¿®å¤æµè§ˆå™¨è‡ªåŠ¨å¡«å……èƒŒæ™¯å˜ç™½çš„é—®é¢˜ */
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus {
            -webkit-text-fill-color: #fff; transition: background-color 5000s ease-in-out 0s;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn-main, .btn-secondary {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            color: white; font-size: 1.15rem; font-weight: bold; cursor: pointer;
            transition: 0.3s; letter-spacing: 1px;
        }
        .btn-main {
            background: linear-gradient(135deg, #6a00f4 0%, #c300ff 100%);
            box-shadow: 0 5px 20px rgba(195, 0, 255, 0.4); margin-top: 15px;
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(195, 0, 255, 0.6); filter: brightness(1.1); }
        
        .btn-secondary {
            background: transparent; border: 2px solid rgba(255,255,255,0.3);
            margin-top: 30px; font-size: 1rem;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: var(--gold); color: var(--gold); }

        /* --- ç»“æœé¡µ & Premium åŒºåŸŸ --- */
        #result-section { display: none; opacity: 0; transition: opacity 0.8s ease-out; }
        .fade-in { opacity: 1 !important; }

        /* Premium é”å®šåŒºåŸŸ - éœ“è™¹ä¸è„‰åŠ¨æ•ˆæœ */
        .premium-lock-area {
            position: relative; overflow: hidden; 
            background: linear-gradient(135deg, rgba(20, 10, 40, 0.8), rgba(40, 20, 60, 0.9));
            border: 2px solid var(--accent-pink); 
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.3);
            padding: 0; min-height: 220px; display: flex; flex-direction: column; justify-content: center;
        }

        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10, 5, 20, 0.8); z-index: 5; backdrop-filter: blur(5px); padding: 30px;
        }
        
        .premium-title { font-size: 1.5rem; margin: 10px 0; color: #fff; font-weight: bold; }
        .premium-desc { font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px; color: #ddd; max-width: 85%; line-height: 1.5; }

        /* è§£é”æŒ‰é’® - å‘¼å¸æ•ˆæœ */
        .btn-premium {
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            color: #1a0b2e; border: none; padding: 14px 35px; border-radius: 35px;
            font-weight: 900; font-size: 1.05rem; cursor: pointer; 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            animation: pulse 2.5s infinite ease-in-out; letter-spacing: 0.5px; transition: 0.3s;
        }
        .btn-premium:hover { transform: scale(1.05); box-shadow: 0 0 35px rgba(255, 215, 0, 0.7); }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); } 50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); } }

        /* æ˜Ÿç›˜å¯è§†åŒ– */
        .chart-wrapper { width: 280px; height: 280px; margin: 0 auto 35px auto; position: relative; }
        .zodiac-svg { width: 100%; height: 100%; animation: rotate-slow 150s linear infinite; }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .planet-marker { position: absolute; top: 50%; left: 50%; width: 2px; height: 50%; transform-origin: top center; pointer-events: none; }
        .planet-icon {
            position: absolute; bottom: 0; left: -11px; width: 22px; height: 22px;
            background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--purple-deep); font-weight: bold; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 10px rgba(255,255,255,0.7); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .planet-icon:hover { transform: scale(1.8); z-index: 100; box-shadow: 0 0 20px var(--gold); background: var(--gold); }

        /* Loader */
        .loader { display: none; width: 40px; height: 40px; margin: 20px auto; border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container { width: 94%; margin-top: 60px; }
            h1 { font-size: 2rem; }
            .glass-card { padding: 20px; }
        }
    </style>
</head>
<body class="lang-cn">

    <div class="stars-overlay" id="stars-container"></div>

    <div class="lang-switch">
        <button class="lang-btn active" onclick="changeLang('cn')">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="changeLang('en')">EN</button>
    </div>

    <div class="container">
        <header id="main-header">
            <h1 class="serif-font" id="i18n-title">æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾ âœ¨</h1>
            <p class="subtitle" id="i18n-subtitle">AIè§£æä½ çš„çµé­‚Â·æ¡ƒèŠ±Â·å‘½è¿è½¨è¿¹</p>
        </header>

        <div class="glass-card" id="input-card">
            <form id="astro-form">
                <div class="input-group">
                    <label id="lbl-name">ä½ çš„åå­—</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥åå­— (å¯é€‰)">
                </div>
                <div class="input-group">
                    <label id="lbl-dob">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birthdate" required>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="flex:1">
                        <label id="lbl-time">å‡ºç”Ÿæ—¶é—´ (å…³é”®)</label>
                        <input type="time" id="birthtime" required>
                    </div>
                    <div class="input-group" style="flex:1">
                        <label id="lbl-city">å‡ºç”ŸåŸå¸‚</label>
                        <input type="text" id="city" placeholder="ä¾‹å¦‚: ä¸Šæµ·" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-main" id="btn-submit">âœ¨ å¼€å¯å‘½è¿æ˜Ÿç›˜ âœ¨</button>
            </form>
            <div class="loader" id="loader"></div>
        </div>

        <div id="result-section">
            <h2 class="serif-font" style="color: var(--gold); margin-bottom: 25px; font-size: 1.8rem;">
                <span id="res-name-display"></span> <span id="i18n-report-title">çš„æ˜Ÿç›˜æŠ¥å‘Š</span>
            </h2>

            <div class="glass-card chart-wrapper" style="padding: 0; background: transparent; box-shadow: none; border: none;">
                <svg id="zodiac-wheel" class="zodiac-svg" viewBox="0 0 200 200"></svg>
                <div id="planet-layer"></div>
            </div>

            <div class="glass-card" style="text-align: left; padding: 25px 30px;">
                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--gold); font-size: 1.2rem;">â˜€ï¸ <span id="lbl-sun">å¤ªé˜³</span>: </strong>
                    <span id="val-sun" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.6;" id="desc-sun">--</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--gold); font-size: 1.2rem;">ğŸŒ™ <span id="lbl-moon">æœˆäº®</span>: </strong>
                    <span id="val-moon" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.6;" id="desc-moon">--</p>
                </div>
                <div>
                    <strong style="color: var(--gold); font-size: 1.2rem;">ğŸ¹ <span id="lbl-rising">ä¸Šå‡</span>: </strong>
                    <span id="val-rising" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.6;" id="desc-rising">--</p>
                </div>
            </div>

            <div class="glass-card premium-lock-area" id="premium-area">
                <div class="lock-overlay" id="lock-overlay">
                    <div style="font-size: 2.5rem; margin-bottom: 15px; color: var(--gold); filter: drop-shadow(0 0 10px var(--gold));">ğŸ”“</div>
                    <h3 class="premium-title serif-font" id="i18n-premium-title">è§£é” Premium æ·±åº¦æŠ¥å‘Š</h3>
                    <p class="premium-desc" id="i18n-premium-subtitle">
                        åŒ…å«ï¼š2026 æ¡ƒèŠ±æ­£ç¼˜é¢„æµ‹ Â· åŒäººåˆç›˜å…¼å®¹æ€§ Â· å®Œæ•´ PDF ä¸‹è½½
                    </p>
                    <button class="btn-premium" onclick="unlockPremium()" id="btn-unlock">
                        ç«‹å³è§£é” (ï¿¥19.9)
                    </button>
                </div>

                <div id="premium-content" style="display: none; padding: 15px 20px; text-align: left;">
                    <h3 class="serif-font" style="color: var(--accent-pink); margin-bottom: 15px; font-size: 1.4rem;">ğŸŒ¸ <span id="i18n-love-title">2026 æ¡ƒèŠ±è¿åŠ¿</span></h3>
                    <div id="love-forecast-text" style="font-size: 1rem; line-height: 1.7; margin-bottom: 30px; color: #eee;"></div>
                    
                    <button class="btn-main" id="btn-pdf" style="background: transparent; border: 2px solid rgba(255,255,255,0.7);" onclick="downloadPDF()">
                        ğŸ“¥ ä¸‹è½½å®Œæ•´ PDF æŠ¥å‘Š
                    </button>
                </div>
            </div>

            <button class="btn-secondary" id="btn-retest" onclick="resetPage()">
                ğŸ”„ é‡æ–°æµ‹è¯•æ˜Ÿç›˜
            </button>

            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 30px; letter-spacing: 1px;" id="footer-text">
                ä»…ä¾›å¨±ä¹å‚è€ƒ Â· Mock Mode Active
            </p>
        </div>
    </div>

    <script>
        // --- é…ç½® ---
        const USE_REAL_API = false; // Mock æ¨¡å¼ï¼Œæ¼”ç¤ºç”¨
        const API_KEY = 'YOUR_API_KEY'; 
        const API_URL = 'https://json.freeastrologyapi.com/planets';

        // --- æ¯æ—¥èƒŒæ™¯å›¾æ•°ç»„ (é«˜è´¨é‡ Unsplash å›¾æº) ---
        const dayBgs = [
            'https://images.unsplash.com/photo-1603852452378-a4e8d84324a2?w=1600&q=80', // ç²‰ç´«äº‘
            'https://images.unsplash.com/photo-1516339901601-2e1b62dc0c45?w=1600&q=80', // æ¢¦å¹»å¤©ç©º
            'https://images.unsplash.com/photo-1533208087231-c3618eab623c?w=1600&q=80', // æ·¡å½©äº‘å±‚
            'https://images.unsplash.com/photo-1570032257806-7272438f38da?w=1600&q=80', // æŸ”å’Œæ—¥å‡º
            'https://images.unsplash.com/photo-1620052581237-5d36667be337?w=1600&q=80'  // é­”æ³•å¤©ç©º
            // ... å¯ç»§ç»­æ·»åŠ è‡³15å¼ +
        ];
        const nightBgs = [
            'https://images.unsplash.com/photo-1536924430914-91f9e2041b83?w=1600&q=80', // æ·±é‚ƒæ˜Ÿäº‘
            'https://images.unsplash.com/photo-1464802686167-b93944301adf?w=1600&q=80', // é“¶æ²³
            'https://images.unsplash.com/photo-1506318137071-a8e063b4ef0d?w=1600&q=80', // é»‘æš—æ˜Ÿç©º
            'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1600&q=80', // å®‡å®™å°˜åŸƒ
            'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=1600&q=80'  // è“è‰²æ˜Ÿç³»
             // ... å¯ç»§ç»­æ·»åŠ è‡³15å¼ +
        ];

        // --- i18n å…¨é¢ç¿»è¯‘å­—å…¸ ---
        const TRANSLATIONS = {
            cn: {
                title: "æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾ âœ¨",
                subtitle: "AIè§£æä½ çš„çµé­‚Â·æ¡ƒèŠ±Â·å‘½è¿è½¨è¿¹",
                lblName: "ä½ çš„åå­—", phName: "è¯·è¾“å…¥åå­— (å¯é€‰)",
                lblDob: "å‡ºç”Ÿæ—¥æœŸ",
                lblTime: "å‡ºç”Ÿæ—¶é—´ (å…³é”®)",
                lblCity: "å‡ºç”ŸåŸå¸‚", phCity: "ä¾‹å¦‚: ä¸Šæµ·",
                btnSubmit: "âœ¨ å¼€å¯å‘½è¿æ˜Ÿç›˜ âœ¨",
                reportTitle: "çš„æ˜Ÿç›˜æŠ¥å‘Š",
                sun: "å¤ªé˜³", moon: "æœˆäº®", rising: "ä¸Šå‡",
                descSun: "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ã€ç”Ÿå‘½åŠ›ä¸äººç”Ÿç›®æ ‡ã€‚ä½ æ˜¯å¦‚ä½•å‘å…‰å‘çƒ­çš„ã€‚",
                descMoon: "ä½ çš„å†…åœ¨æƒ…æ„Ÿã€æ½œæ„è¯†éœ€æ±‚ä¸å®‰å…¨æ„Ÿæ¥æºã€‚ä½ çµé­‚æ·±å¤„çš„æ¸´æœ›ã€‚",
                descRising: "ä½ æˆ´çš„é¢å…·ï¼Œä»–äººå¯¹ä½ çš„ç¬¬ä¸€å°è±¡ä¸å¤–åœ¨è¡Œä¸ºæ¨¡å¼ã€‚ä½ èµ°å‘ä¸–ç•Œçš„æ–¹å¼ã€‚",
                premiumTitle: "è§£é” Premium æ·±åº¦æŠ¥å‘Š",
                premiumSubtitle: "åŒ…å«ï¼š2026 æ¡ƒèŠ±æ­£ç¼˜é¢„æµ‹ Â· åŒäººåˆç›˜å…¼å®¹æ€§ Â· å®Œæ•´ PDF ä¸‹è½½",
                btnUnlock: "ç«‹å³è§£é” (ï¿¥19.9)",
                loveTitle: "2026 æ¡ƒèŠ±è¿åŠ¿",
                btnPdf: "ğŸ“¥ ä¸‹è½½å®Œæ•´ PDF æŠ¥å‘Š",
                btnRetest: "ğŸ”„ é‡æ–°æµ‹è¯•æ˜Ÿç›˜",
                footer: "ä»…ä¾›å¨±ä¹å‚è€ƒ Â· Mock Mode Active",
                zodiacNames: ["ç™½ç¾Šåº§", "é‡‘ç‰›åº§", "åŒå­åº§", "å·¨èŸ¹åº§", "ç‹®å­åº§", "å¤„å¥³åº§", "å¤©ç§¤åº§", "å¤©èåº§", "å°„æ‰‹åº§", "æ‘©ç¾¯åº§", "æ°´ç“¶åº§", "åŒé±¼åº§"],
                alertPay: "æ”¯ä»˜æˆåŠŸï¼(æ¨¡æ‹Ÿ)",
                alertPdf: "æ­£åœ¨ç”Ÿæˆé«˜æ¸… PDFï¼Œè¯·ç¨å€™...",
                defaultName: "æ—…è¡Œè€…"
            },
            en: {
                title: "Cosmic Soul Chart âœ¨ - Unlock Your Destiny",
                subtitle: "AI Analysis of your Soul Path, Love & Fate Blueprint.",
                lblName: "Your Name", phName: "Enter Name (Optional)",
                lblDob: "Date of Birth",
                lblTime: "Birth Time (Crucial)",
                lblCity: "City of Birth", phCity: "e.g., New York",
                btnSubmit: "âœ¨ Reveal My Cosmic Blueprint âœ¨",
                reportTitle: "'s Cosmic Report",
                sun: "Sun", moon: "Moon", rising: "Rising",
                descSun: "Your core identity, vitality, and life purpose. How you shine your light.",
                descMoon: "Your emotional inner world, subconscious needs, and source of security.",
                descRising: "The mask you wear, first impressions, and outward behavior style.",
                premiumTitle: "Unlock Premium Insights",
                premiumSubtitle: "Includes: 2026 Love Forecast Â· Soulmate Compatibility Â· Full PDF Report",
                btnUnlock: "Unlock Now ($2.99)",
                loveTitle: "2026 Love Forecast",
                btnPdf: "ğŸ“¥ Download Full PDF Report",
                btnRetest: "ğŸ”„ Retest Your Chart",
                footer: "For entertainment purposes only Â· Mock Mode Active",
                zodiacNames: ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"],
                alertPay: "Payment Successful! (Mock)",
                alertPdf: "Generating high-quality PDF, please wait...",
                defaultName: "Traveler"
            }
        };

        let currentLang = 'cn';
        let userData = {};

        // --- åˆå§‹åŒ– ---
        window.addEventListener('load', () => {
            initStars();
            initThemeAndBackground(); // åˆå§‹åŒ–ä¸»é¢˜å’ŒèƒŒæ™¯
            drawSVGBg();
        });

        // 1. æ¯æ—¥èƒŒæ™¯ä¸ä¸»é¢˜åˆå§‹åŒ–
        function initThemeAndBackground() {
            const h = new Date().getHours();
            const dayOfMonth = new Date().getDate(); // è·å–ä»Šå¤©æ˜¯å‡ å·
            
            document.body.classList.remove('day-mode', 'night-mode');
            let bgUrl = '';

            // æ ¹æ®æ—¥æœŸé€‰æ‹©ä¸åŒçš„å›¾ç‰‡ç´¢å¼• (ç¡®ä¿æ¯å¤©ä¸åŒ)
            const bgIndex = dayOfMonth % 5; // è¿™é‡Œç”¨ % 5 æ¼”ç¤ºï¼Œå®é™…å¯ç”¨ % æ•°ç»„é•¿åº¦

            if(h >= 6 && h < 18) {
                document.body.classList.add('day-mode');
                bgUrl = dayBgs[bgIndex];
            } else {
                document.body.classList.add('night-mode');
                bgUrl = nightBgs[bgIndex];
            }

            // åŠ¨æ€è®¾ç½®èƒŒæ™¯å›¾ï¼Œå åŠ åœ¨ CSS å®šä¹‰çš„æ¸å˜å±‚ä¹‹ä¸Š
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é‡æ–°ç»„åˆ linear-gradient å’Œ urlï¼Œå› ä¸º JS ä¼šè¦†ç›–æ•´ä¸ª background-image å±æ€§
            const gradient = h >= 6 && h < 18 
                ? 'linear-gradient(to bottom, rgba(120, 80, 180, 0.4), rgba(255, 150, 200, 0.3))' 
                : 'linear-gradient(to bottom, rgba(10, 10, 30, 0.7), rgba(30, 20, 60, 0.8))';
            
            document.body.style.backgroundImage = `${gradient}, url('${bgUrl}')`;
        }

        // 2. å…¨é¢è¯­è¨€åˆ‡æ¢
        function changeLang(lang) {
            currentLang = lang;
            document.body.className = lang === 'cn' ? 'lang-cn' : 'lang-en';
            // é‡æ–°åº”ç”¨ä¸»é¢˜ä»¥ç¡®ä¿èƒŒæ™¯æ­£ç¡® (å› ä¸ºè¦†ç›–äº†className)
            initThemeAndBackground();

            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            const t = TRANSLATIONS[lang];
            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å’Œå±æ€§
            const setText = (id, txt) => document.getElementById(id).textContent = txt;
            const setAttr = (id, attr, txt) => document.getElementById(id).setAttribute(attr, txt);

            setText('i18n-title', t.title);
            setText('i18n-subtitle', t.subtitle);
            setText('lbl-name', t.lblName); setAttr('username', 'placeholder', t.phName);
            setText('lbl-dob', t.lblDob);
            setText('lbl-time', t.lblTime);
            setText('lbl-city', t.lblCity); setAttr('city', 'placeholder', t.phCity);
            setText('btn-submit', t.btnSubmit);
            setText('i18n-report-title', t.reportTitle);
            setText('lbl-sun', t.sun); setText('desc-sun', t.descSun);
            setText('lbl-moon', t.moon); setText('desc-moon', t.descMoon);
            setText('lbl-rising', t.rising); setText('desc-rising', t.descRising);
            setText('i18n-premium-title', t.premiumTitle);
            setText('i18n-premium-subtitle', t.premiumSubtitle);
            setText('btn-unlock', t.btnUnlock);
            setText('i18n-love-title', t.loveTitle);
            setText('btn-pdf', t.btnPdf);
            setText('btn-retest', t.btnRetest);
            setText('footer-text', t.footer);

            // åˆ·æ–°åŠ¨æ€æ•°æ®æ˜¾ç¤º
            if(userData.sun) {
                 setText('val-sun', t.zodiacNames[userData.sun.index]);
                 setText('val-moon', t.zodiacNames[userData.moon.index]);
                 setText('val-rising', t.zodiacNames[userData.rising.index]);
                 if(document.getElementById('premium-content').style.display === 'block') {
                     generateLoveText(); // åˆ·æ–°å·²è§£é”çš„æ–‡æœ¬
                 }
            }
        }

        // 3. é‡æ–°æµ‹è¯•åŠŸèƒ½
        function resetPage() {
            // éšè—ç»“æœï¼Œæ˜¾ç¤ºè¡¨å•
            document.getElementById('result-section').classList.remove('fade-in');
            setTimeout(() => {
                document.getElementById('result-section').style.display = 'none';
                document.getElementById('input-card').style.display = 'block';
                document.getElementById('main-header').style.display = 'block';
                // é‡ç½®è¡¨å•
                document.getElementById('astro-form').reset();
                // é‡ç½® Premium çŠ¶æ€
                document.getElementById('lock-overlay').style.display = 'flex';
                document.getElementById('premium-content').style.display = 'none';
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 300); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»
        }

        // 4. å®Œç¾ä¸­è‹± PDF ä¸‹è½½ (html2canvas + jsPDF)
        window.downloadPDF = async function() {
            const t = TRANSLATIONS[currentLang];
            alert(t.alertPdf);
            
            const element = document.getElementById('result-section');
            const originalBg = element.style.background;
            // ä¸´æ—¶è®¾ç½®èƒŒæ™¯è‰²ä»¥ç¡®ä¿æˆªå›¾æ¸…æ™°
            element.style.background = 'linear-gradient(to bottom, #1a0b2e, #2a1b3e)'; 
            
            try {
                // ä½¿ç”¨ html2canvas æˆªå›¾
                const canvas = await html2canvas(element, {
                    scale: 2, // æé«˜æ¸…æ™°åº¦
                    useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡ (å¦‚æœSVGå†…æœ‰å¤–éƒ¨èµ„æº)
                    logging: false,
                    backgroundColor: null // é€æ˜èƒŒæ™¯
                });
                
                // æ¢å¤èƒŒæ™¯
                element.style.background = originalBg;

                const imgData = canvas.toDataURL('image/png');
                
                // åˆ›å»º PDF (A4çºµå‘)
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                // å°†æˆªå›¾æ”¾å…¥ PDFï¼Œè‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”å®½åº¦
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                const fileName = `Cosmic_Report_${userData.name || 'User'}.pdf`;
                pdf.save(fileName);
                
            } catch (err) {
                console.error("PDF Generation Error:", err);
                alert("PDF ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
                element.style.background = originalBg;
            }
        }

        // --- è¾…åŠ©å‡½æ•° (æ˜Ÿæ˜Ÿ, SVG, Mockæ•°æ®ç­‰) ---
        function initStars() {
            const container = document.getElementById('stars-container');
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*100 + '%';
                const size = Math.random()*2 + 1; s.style.width = size+'px'; s.style.height = size+'px';
                s.style.setProperty('--duration', (Math.random()*4+3)+'s'); s.style.opacity = Math.random();
                container.appendChild(s);
            }
        }

        function drawSVGBg() {
            const svg = document.getElementById('zodiac-wheel');
            const cx = 100, cy = 100, r = 98;
            const symbols = ["â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“"];
            let html = `<circle cx="100" cy="100" r="${r}" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1" />`;
            for(let i=0; i<12; i++) {
                const angle = (i*30)*(Math.PI/180);
                const x2 = cx + r*Math.cos(angle); const y2 = cy + r*Math.sin(angle);
                html += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="rgba(255,255,255,0.15)" stroke-width="1" />`;
                const textAngle = (i*30+15)*(Math.PI/180);
                const tx = cx + (r-12)*Math.cos(textAngle); const ty = cy + (r-12)*Math.sin(textAngle);
                html += `<text x="${tx}" y="${ty}" fill="rgba(255,255,255,0.7)" font-size="10" text-anchor="middle" dominant-baseline="middle" transform="rotate(${i*30+15+90}, ${tx}, ${ty})">${symbols[i]}</text>`;
            }
            svg.innerHTML = html;
        }

        // --- è¡¨å•æäº¤æ ¸å¿ƒé€»è¾‘ ---
        document.getElementById('astro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const t = TRANSLATIONS[currentLang];
            const name = document.getElementById('username').value || t.defaultName;
            const date = document.getElementById('birthdate').value;
            const time = document.getElementById('birthtime').value;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('btn-submit').style.display = 'none';

            // æ¨¡æ‹Ÿ API è°ƒç”¨å»¶è¿Ÿ
            await new Promise(r => setTimeout(r, 1500));
            
            // Mock æ•°æ®ç”Ÿæˆ
            userData = { name, ...getMockData(date, time) };
            renderResults();
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('btn-submit').style.display = 'block';
        });

        function getMockData(dateStr, timeStr) {
            const d = new Date(dateStr);
            const m = d.getMonth() + 1; const day = d.getDate();
            // ç®€æ˜“æ˜Ÿåº§ç´¢å¼•è®¡ç®— (0=ç™½ç¾Š)
            let sunIdx = 0;
            if((m==3&&day>=21)||(m==4&&day<=19)) sunIdx=0; else if((m==4&&day>=20)||(m==5&&day<=20)) sunIdx=1;
            else if((m==5&&day>=21)||(m==6&&day<=21)) sunIdx=2; else if((m==6&&day>=22)||(m==7&&day<=22)) sunIdx=3;
            else if((m==7&&day>=23)||(m==8&&day<=22)) sunIdx=4; else if((m==8&&day>=23)||(m==9&&day<=22)) sunIdx=5;
            else if((m==9&&day>=23)||(m==10&&day<=23)) sunIdx=6; else if((m==10&&day>=24)||(m==11&&day<=22)) sunIdx=7;
            else if((m==11&&day>=23)||(m==12&&day<=21)) sunIdx=8; else if((m==12&&day>=22)||(m==1&&day<=19)) sunIdx=9;
            else if((m==1&&day>=20)||(m==2&&day<=18)) sunIdx=10; else sunIdx=11;

            const seed = dateStr + timeStr;
            const hash = seed.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
            return {
                sun: { index: sunIdx, degree: sunIdx*30+15 },
                moon: { index: (hash+3)%12, degree: ((hash+3)%12)*30+Math.random()*30 },
                rising: { index: (hash+7)%12, degree: ((hash+7)%12)*30+Math.random()*30 }
            };
        }

        function renderResults() {
            const t = TRANSLATIONS[currentLang];
            const signs = t.zodiacNames;
            document.getElementById('input-card').style.display = 'none';
            document.getElementById('main-header').style.display = 'none';
            const resSec = document.getElementById('result-section');
            resSec.style.display = 'block';
            setTimeout(()=>resSec.classList.add('fade-in'), 50);

            document.getElementById('res-name-display').textContent = userData.name;
            document.getElementById('val-sun').textContent = signs[userData.sun.index];
            document.getElementById('val-moon').textContent = signs[userData.moon.index];
            document.getElementById('val-rising').textContent = signs[userData.rising.index];

            const layer = document.getElementById('planet-layer');
            layer.innerHTML = '';
            addPlanet(layer, 'â˜€ï¸', userData.sun.degree + 180);
            addPlanet(layer, 'ğŸŒ™', userData.moon.degree + 180);
            addPlanet(layer, 'ğŸ¹', userData.rising.degree + 180);
        }

        function addPlanet(container, iconChar, degree) {
            const marker = document.createElement('div');
            marker.className = 'planet-marker'; marker.style.transform = `rotate(${degree}deg)`;
            const icon = document.createElement('div');
            icon.className = 'planet-icon'; icon.innerHTML = iconChar; icon.style.transform = `rotate(-${degree}deg)`;
            marker.appendChild(icon); container.appendChild(marker);
        }

        // Premium åŠŸèƒ½
        function unlockPremium() {
            alert(TRANSLATIONS[currentLang].alertPay);
            document.getElementById('lock-overlay').style.display = 'none';
            document.getElementById('premium-content').style.display = 'block';
            generateLoveText();
        }

        function generateLoveText() {
            const t = TRANSLATIONS[currentLang];
            const signs = t.zodiacNames;
            const loveSign = signs[(userData.rising.index + 6) % 12]; 
            const textCN = `æ ¹æ®ä½ çš„æ˜Ÿç›˜é…ç½®ï¼Œ**2026å¹´**ä½ çš„æ¡ƒèŠ±èƒ½é‡æå¼ºã€‚ä½ çš„æ­£ç¼˜å®¿å‘½æ˜Ÿåº§å€¾å‘äº **${loveSign}** ç‰¹è´¨ã€‚å…³é”®æ—¶é—´ç‚¹å‡ºç°åœ¨ **5æœˆå’Œ11æœˆ**ã€‚å»ºè®®ç•™æ„åœ¨å­¦ä¹ ã€æ—…è¡Œæˆ–ç²¾ç¥äº¤æµåœºåˆé‡åˆ°çš„äººã€‚`;
            const textEN = `Based on your chart, your love energy peaks in **2026**. Your soulmate likely embodies **${loveSign}** traits. Key timing: **May & November**. Look for connections during travel or learning activities.`;
            document.getElementById('love-forecast-text').innerHTML = currentLang === 'cn' ? textCN : textEN;
        }
    </script>
</body>
</html>
