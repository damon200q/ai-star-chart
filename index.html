<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Lato:wght@300;400;700&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ==================== CSS æ ¸å¿ƒæ ·å¼ ==================== */
        :root {
            --gold: #FFD700;
            --purple-deep: #1a0b2e; /* é»˜è®¤æ·±åº•è‰² */
            --glass-bg: rgba(20, 20, 35, 0.75); /* ç¨å¾®åŠ æ·±ç»ç’ƒèƒŒæ™¯ */
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --accent-pink: #ff00cc;
            /* å®šä¹‰å­—ä½“å˜é‡ */
            --font-en-title: 'Cinzel Decorative', cursive;
            --font-en-body: 'Lato', sans-serif;
            --font-cn-title: 'Noto Serif SC', serif;
            --font-cn-body: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            /* é»˜è®¤ä½¿ç”¨æ·±è‰²èƒŒæ™¯ï¼Œé˜²æ­¢åˆ‡æ¢æ—¶é—ªç™½ */
            background-color: var(--purple-deep);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            /* å¹³æ»‘è¿‡æ¸¡èƒŒæ™¯å›¾ */
            transition: background-image 0.8s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* --- å­—ä½“æ ¹æ®è¯­è¨€åˆ‡æ¢ --- */
        /* ä¸­æ–‡æ¨¡å¼ */
        body.lang-cn { font-family: var(--font-cn-body); }
        body.lang-cn h1, body.lang-cn h2, body.lang-cn h3, body.lang-cn .serif-font { font-family: var(--font-cn-title); }

        /* è‹±æ–‡æ¨¡å¼ */
        body.lang-en { font-family: var(--font-en-body); letter-spacing: 0.5px; }
        /* è‹±æ–‡æ ‡é¢˜ä½¿ç”¨æ–°çš„ç¥ç§˜å­—ä½“ï¼Œå¹¶å¢åŠ å­—é—´è· */
        body.lang-en h1, body.lang-en h2, body.lang-en h3, body.lang-en .serif-font { font-family: var(--font-en-title); letter-spacing: 2px; font-weight: 900; }


        /* --- åŠ¨æ€èƒŒæ™¯å›¾ (åŸºäºå‚è€ƒçµæ„Ÿæ›´æ–°) --- */
        /* å¤œæ™šæ¨¡å¼ï¼šæ·±é‚ƒæ˜Ÿç©º/æ˜Ÿäº‘ */
        body.night-mode {
            background-image: linear-gradient(to bottom, rgba(10, 10, 30, 0.7), rgba(30, 20, 60, 0.8)), url('https://images.unsplash.com/photo-1536924430914-91f9e2041b83?q=80&w=2070&auto=format&fit=crop');
        }
        /* ç™½å¤©æ¨¡å¼ï¼šæ¢¦å¹»ç²‰ç´«äº‘å±‚ */
        body.day-mode {
            background-image: linear-gradient(to bottom, rgba(120, 80, 180, 0.4), rgba(255, 150, 200, 0.3)), url('https://images.unsplash.com/photo-1603852452378-a4e8d84324a2?q=80&w=1974&auto=format&fit=crop');
        }

        /* æ˜Ÿæ˜ŸåŠ¨ç”»å±‚ */
        .stars-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; mix-blend-mode: screen;}
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- è¯­è¨€åˆ‡æ¢å™¨ --- */
        .lang-switch { position: absolute; top: 25px; right: 25px; z-index: 10; display: flex; gap: 10px; }
        .lang-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #ddd;
            padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 0.85rem; backdrop-filter: blur(5px);
        }
        .lang-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .lang-btn.active { background: var(--gold); color: #1a0b2e; border-color: var(--gold); font-weight: bold; }

        /* --- ä¸»å®¹å™¨ --- */
        .container { width: 90%; max-width: 580px; margin: 80px auto 60px; text-align: center; z-index: 2; position: relative; }

        /* æ ‡é¢˜æ ·å¼ä¼˜åŒ– */
        h1 {
            font-size: 2.4rem; margin-bottom: 15px;
            /* é‡‘è‰²æ¸å˜æ–‡å­— */
            background: linear-gradient(to right, #fff 20%, var(--gold) 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            /* å‘å…‰æ•ˆæœ */
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
            line-height: 1.2;
        }
        .subtitle { font-size: 1.05rem; color: rgba(255,255,255,0.8); margin-bottom: 35px; font-weight: 300; letter-spacing: 0.5px; }

        /* --- å¡ç‰‡é€šç”¨æ ·å¼ --- */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: 20px; padding: 30px; margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); transition: transform 0.3s;
        }
        
        /* è¡¨å•æ ·å¼ */
        .input-group { text-align: left; margin-bottom: 18px; }
        label { color: var(--gold); font-size: 0.85rem; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700;}
        input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 10px;
            color: #fff; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); background: rgba(0,0,0,0.4); box-shadow: 0 0 12px rgba(255, 215, 0, 0.2); }
        /* ä¿®å¤æµè§ˆå™¨è‡ªåŠ¨å¡«å……èƒŒæ™¯å˜ç™½çš„é—®é¢˜ */
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus {
            -webkit-text-fill-color: #fff; transition: background-color 5000s ease-in-out 0s;
        }

        /* ä¸»æŒ‰é’® */
        .btn-main {
            width: 100%; padding: 16px; margin-top: 15px;
            /* ç´«ç²‰è‰²æ¸å˜ */
            background: linear-gradient(135deg, #6a00f4 0%, #c300ff 100%);
            border: none; border-radius: 50px; color: white; font-size: 1.15rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 20px rgba(195, 0, 255, 0.4); transition: 0.3s; letter-spacing: 1px;
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(195, 0, 255, 0.6); filter: brightness(1.1); }

        /* --- ç»“æœé¡µ & Premium åŒºåŸŸä¼˜åŒ– --- */
        #result-section { display: none; opacity: 0; transition: opacity 0.8s ease-out; }
        .fade-in { opacity: 1 !important; }

        /* Premium é”å®šåŒºåŸŸ - å°ºå¯¸å¢å¤§ */
        .premium-lock-area {
            position: relative; overflow: hidden; 
            background: linear-gradient(135deg, rgba(20, 10, 40, 0.8), rgba(40, 20, 60, 0.9));
            border: 2px solid var(--accent-pink); 
            padding: 0; /* å†…éƒ¨ padding ç”± overlay å†³å®š */
            min-height: 220px; /* è®¾ç½®æœ€å°é«˜åº¦ï¼Œç¡®ä¿ä¸æ‹¥æŒ¤ */
            display: flex; flex-direction: column; justify-content: center;
        }

        /* é”å®šè¦†ç›–å±‚ - å¢åŠ å†…è¾¹è· */
        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10, 5, 20, 0.75); z-index: 5;
            backdrop-filter: blur(4px);
            padding: 30px; /* å¢åŠ å†…éƒ¨ç©ºé—´ */
        }
        
        .premium-title { font-size: 1.5rem; margin: 10px 0; color: #fff; font-weight: bold; }
        .premium-desc { font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px; color: #ddd; max-width: 80%; line-height: 1.5; }

        /* è§£é”æŒ‰é’® */
        .btn-premium {
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            color: #1a0b2e; border: none; padding: 14px 35px; border-radius: 35px;
            font-weight: 900; font-size: 1.05rem; cursor: pointer; 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            animation: pulse 2s infinite; letter-spacing: 0.5px;
            transition: 0.3s;
        }
        .btn-premium:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* æ˜Ÿç›˜å¯è§†åŒ–å®¹å™¨ */
        .chart-wrapper { width: 280px; height: 280px; margin: 0 auto 35px auto; position: relative; }
        .zodiac-svg { width: 100%; height: 100%; animation: rotate-slow 150s linear infinite; }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* è¡Œæ˜Ÿå›¾æ ‡ */
        .planet-marker { position: absolute; top: 50%; left: 50%; width: 2px; height: 50%; transform-origin: top center; pointer-events: none; }
        .planet-icon {
            position: absolute; bottom: 0; left: -11px; width: 22px; height: 22px;
            background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--purple-deep); font-weight: bold; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 10px rgba(255,255,255,0.7); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .planet-icon:hover { transform: scale(1.8); z-index: 100; box-shadow: 0 0 20px var(--gold); background: var(--gold); }

        /* Loader */
        .loader { display: none; width: 40px; height: 40px; margin: 20px auto; border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container { width: 94%; margin-top: 60px; }
            h1 { font-size: 2rem; }
            .glass-card { padding: 20px; }
            .premium-lock-area { min-height: 200px; }
            .lock-overlay { padding: 20px; }
            .premium-title { font-size: 1.3rem; }
        }
    </style>
</head>
<body class="lang-cn">

    <div class="stars-overlay" id="stars-container"></div>

    <div class="lang-switch">
        <button class="lang-btn active" onclick="changeLang('cn')">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="changeLang('en')">EN</button>
    </div>

    <div class="container">
        <header>
            <h1 class="serif-font" id="i18n-title">æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾ âœ¨</h1>
            <p class="subtitle" id="i18n-subtitle">AIè§£æä½ çš„çµé­‚Â·æ¡ƒèŠ±Â·å‘½è¿è½¨è¿¹</p>
        </header>

        <div class="glass-card" id="input-card">
            <form id="astro-form">
                <div class="input-group">
                    <label id="lbl-name">ä½ çš„åå­—</label>
                    <input type="text" id="username" placeholder="Name">
                </div>
                <div class="input-group">
                    <label id="lbl-dob">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birthdate" required>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="flex:1">
                        <label id="lbl-time">å‡ºç”Ÿæ—¶é—´ (å…³é”®)</label>
                        <input type="time" id="birthtime" required>
                    </div>
                    <div class="input-group" style="flex:1">
                        <label id="lbl-city">å‡ºç”ŸåŸå¸‚</label>
                        <input type="text" id="city" placeholder="City" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-main" id="btn-submit">âœ¨ å¼€å¯å‘½è¿æ˜Ÿç›˜ âœ¨</button>
            </form>
            <div class="loader" id="loader"></div>
        </div>

        <div id="result-section">
            <h2 class="serif-font" style="color: var(--gold); margin-bottom: 25px; font-size: 1.8rem;">
                <span id="res-name-display"></span> <span id="i18n-report-title">çš„æ˜Ÿç›˜æŠ¥å‘Š</span>
            </h2>

            <div class="glass-card chart-wrapper" style="padding: 0; background: transparent; box-shadow: none; border: none;">
                <svg id="zodiac-wheel" class="zodiac-svg" viewBox="0 0 200 200"></svg>
                <div id="planet-layer"></div>
            </div>

            <div class="glass-card" style="text-align: left; padding: 25px 30px;">
                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--gold); font-size: 1.2rem;">â˜€ï¸ <span id="lbl-sun">å¤ªé˜³</span>: </strong>
                    <span id="val-sun" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.5;" id="desc-sun">--</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--gold); font-size: 1.2rem;">ğŸŒ™ <span id="lbl-moon">æœˆäº®</span>: </strong>
                    <span id="val-moon" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.5;" id="desc-moon">--</p>
                </div>
                <div>
                    <strong style="color: var(--gold); font-size: 1.2rem;">ğŸ¹ <span id="lbl-rising">ä¸Šå‡</span>: </strong>
                    <span id="val-rising" style="font-weight: bold; margin-left: 5px;">--</span>
                    <p style="font-size: 0.95rem; color: #ddd; margin-top: 8px; line-height: 1.5;" id="desc-rising">--</p>
                </div>
            </div>

            <div class="glass-card premium-lock-area">
                <div class="lock-overlay" id="lock-overlay">
                    <div style="font-size: 2.5rem; margin-bottom: 15px; color: var(--gold); filter: drop-shadow(0 0 10px var(--gold));">ğŸ”“</div>
                    <h3 class="premium-title serif-font" id="i18n-premium-title">è§£é” Premium æ·±åº¦æŠ¥å‘Š</h3>
                    <p class="premium-desc" id="i18n-premium-subtitle">
                        åŒ…å«ï¼š2026 æ¡ƒèŠ±æ­£ç¼˜é¢„æµ‹ Â· åŒäººåˆç›˜å…¼å®¹æ€§ Â· å®Œæ•´ PDF ä¸‹è½½
                    </p>
                    <button class="btn-premium" onclick="unlockPremium()" id="btn-unlock">
                        ç«‹å³è§£é” (ï¿¥19.9)
                    </button>
                </div>

                <div id="premium-content" style="display: none; padding: 10px 20px; text-align: left;">
                    <h3 class="serif-font" style="color: var(--accent-pink); margin-bottom: 15px; font-size: 1.4rem;">ğŸŒ¸ <span id="i18n-love-title">2026 æ¡ƒèŠ±è¿åŠ¿</span></h3>
                    <div id="love-forecast-text" style="font-size: 1rem; line-height: 1.7; margin-bottom: 30px; color: #eee;"></div>
                    
                    <button class="btn-main" style="background: transparent; border: 1px solid rgba(255,255,255,0.5); margin-top: 10px;" onclick="alert('PDF Download Feature works best with English content due to font limitations in this demo.')">
                        ğŸ“¥ <span id="btn-pdf">ä¸‹è½½å®Œæ•´ PDF æŠ¥å‘Š</span>
                    </button>
                </div>
            </div>

            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 40px; letter-spacing: 1px;" id="footer-text">
                ä»…ä¾›å¨±ä¹å‚è€ƒ
            </p>
        </div>
    </div>

    <script>
        // --- é…ç½® ---
        const USE_REAL_API = true; // å·²å¯ç”¨çœŸå® API
        // å·²å¡«å…¥ä½ çš„ API Key
        const API_KEY = 'VXr53WIvEJ673ImIg3ogJi9TzSefxZha2rg8wLXj'; 
        const API_URL = 'https://json.freeastrologyapi.com/planets';

        // --- i18n å¤šè¯­è¨€å­—å…¸ (å·²æ›´æ–°è‹±æ–‡æ–‡æœ¬å’Œå­—ä½“æ ·å¼) ---
        const TRANSLATIONS = {
            cn: {
                title: "æ˜Ÿé­‚å åœ Â· æ­ç§˜ä½ çš„å®‡å®™è“å›¾ âœ¨",
                subtitle: "AIè§£æä½ çš„çµé­‚Â·æ¡ƒèŠ±Â·å‘½è¿è½¨è¿¹",
                namePlaceholder: "ä½ çš„åå­—",
                lblDob: "å‡ºç”Ÿæ—¥æœŸ",
                lblTime: "å‡ºç”Ÿæ—¶é—´ (å…³é”®)",
                lblCity: "å‡ºç”ŸåŸå¸‚",
                btnSubmit: "âœ¨ å¼€å¯å‘½è¿æ˜Ÿç›˜ âœ¨",
                reportTitle: "çš„æ˜Ÿç›˜æŠ¥å‘Š",
                sun: "å¤ªé˜³", moon: "æœˆäº®", rising: "ä¸Šå‡",
                descSun: "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ã€ç”Ÿå‘½åŠ›ä¸äººç”Ÿç›®æ ‡ã€‚",
                descMoon: "ä½ çš„å†…åœ¨æƒ…æ„Ÿã€æ½œæ„è¯†éœ€æ±‚ä¸å®‰å…¨æ„Ÿæ¥æºã€‚",
                descRising: "ä½ æˆ´çš„é¢å…·ï¼Œä»–äººå¯¹ä½ çš„ç¬¬ä¸€å°è±¡ä¸å¤–åœ¨è¡Œä¸ºæ¨¡å¼ã€‚",
                premiumTitle: "è§£é” Premium æ·±åº¦æŠ¥å‘Š",
                premiumSubtitle: "åŒ…å«ï¼š2026 æ¡ƒèŠ±æ­£ç¼˜é¢„æµ‹ Â· åŒäººåˆç›˜å…¼å®¹æ€§ Â· å®Œæ•´ PDF ä¸‹è½½",
                btnUnlock: "ç«‹å³è§£é” (ï¿¥19.9)",
                loveTitle: "2026 æ¡ƒèŠ±è¿åŠ¿",
                btnPdf: "ä¸‹è½½å®Œæ•´ PDF æŠ¥å‘Š",
                footer: "ä»…ä¾›å¨±ä¹å‚è€ƒ",
                zodiacNames: ["ç™½ç¾Šåº§", "é‡‘ç‰›åº§", "åŒå­åº§", "å·¨èŸ¹åº§", "ç‹®å­åº§", "å¤„å¥³åº§", "å¤©ç§¤åº§", "å¤©èåº§", "å°„æ‰‹åº§", "æ‘©ç¾¯åº§", "æ°´ç“¶åº§", "åŒé±¼åº§"]
            },
            en: {
                title: "Cosmic Soul Chart âœ¨ - Unlock Destiny",
                subtitle: "AI Analysis of your Soul Path, Love & Fate.",
                namePlaceholder: "Your Name",
                lblDob: "Date of Birth",
                lblTime: "Birth Time (Crucial)",
                lblCity: "City of Birth",
                btnSubmit: "âœ¨ Reveal My Blueprint âœ¨",
                reportTitle: "'s Cosmic Report",
                sun: "Sun", moon: "Moon", rising: "Rising",
                descSun: "Your core identity, vitality, and life purpose.",
                descMoon: "Your emotional inner world, subconscious needs, and security.",
                descRising: "The mask you wear, first impressions, and outward behavior.",
                premiumTitle: "Unlock Premium Insights",
                premiumSubtitle: "Includes: 2026 Love Forecast Â· Soulmate Compatibility Â· Full PDF Report",
                btnUnlock: "Unlock Now ($2.99)",
                loveTitle: "2026 Love Forecast",
                btnPdf: "Download Full PDF Report",
                footer: "For entertainment purposes only.",
                zodiacNames: ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"]
            }
        };

        let currentLang = 'cn';
        let userData = {};

        // --- åˆå§‹åŒ– ---
        window.addEventListener('load', () => {
            initStars();
            initTheme();
            drawSVGBg();
        });

        // 1. è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        function changeLang(lang) {
            currentLang = lang;
            // åˆ‡æ¢ body class ä»¥åº”ç”¨ä¸åŒçš„å­—ä½“
            document.body.className = lang === 'cn' ? 'lang-cn' : 'lang-en';
            // é‡æ–°åº”ç”¨å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿èƒŒæ™¯å›¾æ­£ç¡®
            initTheme();
            
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            const t = TRANSLATIONS[lang];
            // æ›´æ–°é¡µé¢æ‰€æœ‰æ–‡æœ¬
            document.getElementById('i18n-title').textContent = t.title;
            document.getElementById('i18n-subtitle').textContent = t.subtitle;
            document.getElementById('username').placeholder = t.namePlaceholder;
            document.getElementById('lbl-dob').textContent = t.lblDob;
            document.getElementById('lbl-time').textContent = t.lblTime;
            document.getElementById('lbl-city').textContent = t.lblCity;
            document.getElementById('btn-submit').textContent = t.btnSubmit;
            document.getElementById('i18n-report-title').textContent = t.reportTitle;
            document.getElementById('lbl-sun').textContent = t.sun;
            document.getElementById('lbl-moon').textContent = t.moon;
            document.getElementById('lbl-rising').textContent = t.rising;
            if(document.getElementById('desc-sun').textContent !== '--') {
                 document.getElementById('desc-sun').textContent = t.descSun;
                 document.getElementById('desc-moon').textContent = t.descMoon;
                 document.getElementById('desc-rising').textContent = t.descRising;
            }
            document.getElementById('i18n-premium-title').textContent = t.premiumTitle;
            document.getElementById('i18n-premium-subtitle').textContent = t.premiumSubtitle;
            document.getElementById('btn-unlock').textContent = t.btnUnlock;
            document.getElementById('i18n-love-title').textContent = t.loveTitle;
            document.getElementById('btn-pdf').textContent = t.btnPdf;
            document.getElementById('footer-text').textContent = t.footer;

            // å¦‚æœå·²æœ‰ç»“æœï¼Œåˆ·æ–°æ˜Ÿåº§åæ˜¾ç¤º
            if(userData.sun) {
                 document.getElementById('val-sun').textContent = t.zodiacNames[userData.sun.index];
                 document.getElementById('val-moon').textContent = t.zodiacNames[userData.moon.index];
                 document.getElementById('val-rising').textContent = t.zodiacNames[userData.rising.index];
            }
        }

        // 2. åˆå§‹åŒ–èƒŒæ™¯å’Œæ˜Ÿæ˜Ÿ
        function initStars() {
            const container = document.getElementById('stars-container');
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100 + '%';
                s.style.top = Math.random()*100 + '%';
                const size = Math.random()*2 + 1;
                s.style.width = size + 'px'; s.style.height = size + 'px';
                s.style.setProperty('--duration', (Math.random()*4+3)+'s');
                s.style.opacity = Math.random();
                container.appendChild(s);
            }
        }

        function initTheme() {
            const h = new Date().getHours();
            // ç§»é™¤æ—§ä¸»é¢˜ class
            document.body.classList.remove('day-mode', 'night-mode');
            // æ·»åŠ æ–°ä¸»é¢˜ class
            if(h >= 6 && h < 18) {
                document.body.classList.add('day-mode');
            } else {
                document.body.classList.add('night-mode');
            }
        }

        // ç»˜åˆ¶é™æ€ SVG æ˜Ÿç›˜åº•å›¾
        function drawSVGBg() {
            const svg = document.getElementById('zodiac-wheel');
            const cx = 100, cy = 100, r = 98;
            const symbols = ["â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“"];
            let html = `<circle cx="100" cy="100" r="${r}" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1" />`;
            html += `<circle cx="100" cy="100" r="${r-25}" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1" />`;
            
            for(let i=0; i<12; i++) {
                const angle = (i * 30) * (Math.PI / 180);
                const x2 = cx + r * Math.cos(angle);
                const y2 = cy + r * Math.sin(angle);
                html += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="rgba(255,255,255,0.15)" stroke-width="1" />`;
                
                const textAngle = (i * 30 + 15) * (Math.PI / 180);
                const tx = cx + (r - 12) * Math.cos(textAngle);
                const ty = cy + (r - 12) * Math.sin(textAngle);
                html += `<text x="${tx}" y="${ty}" fill="rgba(255,255,255,0.7)" font-size="10" text-anchor="middle" dominant-baseline="middle" transform="rotate(${i*30+15+90}, ${tx}, ${ty})">${symbols[i]}</text>`;
            }
            svg.innerHTML = html;
        }

        // --- 3. è¡¨å•æäº¤ä¸æ•°æ®è·å– ---
        document.getElementById('astro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('username').value || (currentLang==='cn'?"æ—…è¡Œè€…":"Traveler");
            const date = document.getElementById('birthdate').value;
            const time = document.getElementById('birthtime').value;
            const city = document.getElementById('city').value;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('btn-submit').style.display = 'none';

            try {
                const data = await fetchAstroData(date, time, city);
                userData = { name, ...data };
                renderResults();
            } catch (err) {
                console.error(err);
                alert(currentLang==='cn' ? "è¿æ¥å®‡å®™ä¿¡å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚" : "Failed to connect to the cosmos. Please check network.");
                document.getElementById('btn-submit').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        });

        async function fetchAstroData(dateStr, timeStr, cityStr) {
            // ä½¿ç”¨çœŸå® API
            if (USE_REAL_API) {
                try {
                    console.log("Calling Real API...");
                    // æ„å»º API è¯·æ±‚ä½“ (æ ¹æ® freeastrologyapi æ–‡æ¡£)
                    const requestBody = {
                        year: parseInt(dateStr.split('-')[0]),
                        month: parseInt(dateStr.split('-')[1]),
                        date: parseInt(dateStr.split('-')[2]),
                        hours: parseInt(timeStr.split(':')[0]),
                        minutes: parseInt(timeStr.split(':')[1]),
                        seconds: 0,
                        // æ³¨æ„ï¼šçœŸå®ç¯å¢ƒéœ€è¦å°†åŸå¸‚è½¬æ¢ä¸ºç»çº¬åº¦ (Geocoding)ã€‚
                        // è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€åŒ–ï¼Œä½¿ç”¨å›ºå®šç»çº¬åº¦ (ä¾‹å¦‚ä¸Šæµ·) æˆ– API çš„é»˜è®¤å€¼ã€‚
                        latitude: 31.2304, 
                        longitude: 121.4737,
                        timezone: 8, // æ—¶åŒº
                        settings: {
                            ayanamsa: "LAHIRI",
                            coordinates: "GEOCENTRIC"
                        }
                    };

                    const res = await fetch(API_URL, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': API_KEY // ä½¿ç”¨ä½ çš„ API Key
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    const rawData = await res.json();
                    console.log("API Response:", rawData);
                    return processApiData(rawData);

                } catch (e) {
                    console.warn("API failed, falling back to mock data:", e);
                    // å¦‚æœ API å¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒ
                    await new Promise(r => setTimeout(r, 1000));
                    return getMockData(dateStr, timeStr);
                }
            } else {
                // Mock æ¨¡å¼
                await new Promise(r => setTimeout(r, 1500));
                return getMockData(dateStr, timeStr);
            }
        }

        // å¤„ç† API è¿”å›çš„æ•°æ®æ ¼å¼
        function processApiData(data) {
            // å‡è®¾ API è¿”å›çš„æ•°æ®ç»“æ„ä¸­åŒ…å« output[planet_name].zodiac_sign_code (0-11)
            // å’Œ output[planet_name].longitude (0-360)
            // æ³¨æ„ï¼šä¸åŒçš„ API è¿”å›ç»“æ„ä¸åŒï¼Œè¿™é‡ŒæŒ‰é€šç”¨ç»“æ„å¤„ç†ã€‚
            // å®é™…å¯¹æ¥æ—¶éœ€æ ¹æ® freeastrologyapi çš„å…·ä½“å“åº”è°ƒæ•´ã€‚
            
            // ç”±äº freeastrologyapi çš„å…è´¹ç‰ˆå¯èƒ½ä¸ç›´æ¥è¿”å›ç»“æ„åŒ–çš„ 0-11 ç´¢å¼•ï¼Œ
            // è¿™é‡Œä¸ºäº†æ¼”ç¤º API æµç¨‹ï¼Œæˆ‘ä»¬æš‚æ—¶ç”¨ Mock æ•°æ®å¡«å……ï¼Œ
            // *è¯·åœ¨ç¡®è®¤ API å®é™…è¿”å›ç»“æ„åæ›¿æ¢æ­¤å¤„çš„é€»è¾‘*ã€‚
            console.warn("Processing logic needs adjustment based on actual API response structure.");
            return getMockData("2000-01-01", "12:00"); // ä¸´æ—¶å›é€€
        }


        // æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ (ä½œä¸ºå¤‡ä»½)
        function getMockData(dateStr, timeStr) {
            const d = new Date(dateStr);
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const sunIdx = getZodiacIndex(m, day);
            const seed = dateStr + timeStr;
            const hash = seed.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
            
            return {
                sun: { index: sunIdx, degree: sunIdx * 30 + 15 },
                moon: { index: (hash+3)%12, degree: ((hash+3)%12)*30 + Math.random()*30 },
                rising: { index: (hash+7)%12, degree: ((hash+7)%12)*30 + Math.random()*30 }
            };
        }

        function getZodiacIndex(m, d) {
             // ç®€æ˜“æ˜Ÿåº§æ—¥æœŸåˆ¤æ–­ (0=ç™½ç¾Š, 11=åŒé±¼)
            if((m==3 && d>=21) || (m==4 && d<=19)) return 0;
            if((m==4 && d>=20) || (m==5 && d<=20)) return 1;
            if((m==5 && d>=21) || (m==6 && d<=21)) return 2;
            if((m==6 && d>=22) || (m==7 && d<=22)) return 3;
            if((m==7 && d>=23) || (m==8 && d<=22)) return 4;
            if((m==8 && d>=23) || (m==9 && d<=22)) return 5;
            if((m==9 && d>=23) || (m==10 && d<=23)) return 6;
            if((m==10 && d>=24) || (m==11 && d<=22)) return 7;
            if((m==11 && d>=23) || (m==12 && d<=21)) return 8;
            if((m==12 && d>=22) || (m==1 && d<=19)) return 9;
            if((m==1 && d>=20) || (m==2 && d<=18)) return 10;
            return 11;
        }

        // --- 4. æ¸²æŸ“ç»“æœ ---
        function renderResults() {
            const t = TRANSLATIONS[currentLang];
            const signs = t.zodiacNames;

            document.getElementById('input-card').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            const resSec = document.getElementById('result-section');
            resSec.style.display = 'block';
            setTimeout(()=>resSec.classList.add('fade-in'), 50);

            document.getElementById('res-name-display').textContent = userData.name;
            
            document.getElementById('val-sun').textContent = signs[userData.sun.index];
            document.getElementById('desc-sun').textContent = t.descSun;
            
            document.getElementById('val-moon').textContent = signs[userData.moon.index];
            document.getElementById('desc-moon').textContent = t.descMoon;
            
            document.getElementById('val-rising').textContent = signs[userData.rising.index];
            document.getElementById('desc-rising').textContent = t.descRising;

            const layer = document.getElementById('planet-layer');
            layer.innerHTML = '';
            // æ³¨æ„ï¼šSVGåæ ‡ç³»0åº¦é€šå¸¸åœ¨3ç‚¹é’Ÿæ–¹å‘ï¼Œç™½ç¾Šåº§(Index 0)é€šå¸¸åœ¨9ç‚¹é’Ÿæˆ–12ç‚¹é’Ÿã€‚
            // è¿™é‡Œç®€å•å¤„ç†ï¼šåŠ  180 åº¦ä»¥å¤§è‡´å¯¹é½è§†è§‰ä¹ æƒ¯ã€‚
            addPlanet(layer, 'â˜€ï¸', userData.sun.degree + 180);
            addPlanet(layer, 'ğŸŒ™', userData.moon.degree + 180);
            addPlanet(layer, 'ğŸ¹', userData.rising.degree + 180);
        }

        function addPlanet(container, iconChar, degree) {
            const marker = document.createElement('div');
            marker.className = 'planet-marker';
            marker.style.transform = `rotate(${degree}deg)`;
            const icon = document.createElement('div');
            icon.className = 'planet-icon';
            icon.innerHTML = iconChar;
            icon.style.transform = `rotate(-${degree}deg)`;
            marker.appendChild(icon);
            container.appendChild(marker);
        }

        // --- 5. Premium åŠŸèƒ½ ---
        function unlockPremium() {
            alert(currentLang === 'cn' ? "æ”¯ä»˜æˆåŠŸï¼(æ¨¡æ‹Ÿ)" : "Payment Successful! (Mock)");
            document.getElementById('lock-overlay').style.display = 'none';
            document.getElementById('premium-content').style.display = 'block';
            // ç”Ÿæˆæ¡ƒèŠ±è¿æ–‡æ¡ˆ
            const signs = TRANSLATIONS[currentLang].zodiacNames;
            // ç®€å•é€»è¾‘ï¼šæ­£ç¼˜æ˜¯é‡‘æ˜Ÿ(è¿™é‡Œç”¨ä¸Šå‡ä»£æ›¿æ¼”ç¤º)çš„å¯¹å®«æ˜Ÿåº§
            const loveSign = signs[(userData.rising.index + 6) % 12]; 
            const textCN = `æ ¹æ®ä½ çš„æ˜Ÿç›˜é…ç½®ï¼Œ**2026å¹´**ä½ çš„æ¡ƒèŠ±èƒ½é‡æå¼ºã€‚ä½ çš„æ­£ç¼˜å®¿å‘½æ˜Ÿåº§å€¾å‘äº **${loveSign}** ç‰¹è´¨ã€‚å…³é”®æ—¶é—´ç‚¹å‡ºç°åœ¨ **5æœˆå’Œ11æœˆ**ã€‚å»ºè®®ç•™æ„åœ¨å­¦ä¹ ã€æ—…è¡Œæˆ–ç²¾ç¥äº¤æµåœºåˆé‡åˆ°çš„äººã€‚`;
            const textEN = `Based on your chart, your love energy peaks in **2026**. Your soulmate likely embodies **${loveSign}** traits. Key timing: **May & November**. Look for connections during travel or learning activities.`;
            document.getElementById('love-forecast-text').innerHTML = currentLang === 'cn' ? textCN : textEN;
        }
    </script>
</body>
</html>
